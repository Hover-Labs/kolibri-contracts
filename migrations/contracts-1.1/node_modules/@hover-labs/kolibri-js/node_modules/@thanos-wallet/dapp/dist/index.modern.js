import{nanoid as e}from"nanoid";import{TezosOperationError as s,TezosToolkit as n,createTransferOperation as t,createOriginationOperation as r,createSetDelegateOperation as o}from"@taquito/taquito";var a,i,c;function u(){return new Promise(e=>{const s=e=>{var s,t;e.source===window&&(null===(s=e.data)||void 0===s?void 0:s.type)===c.Response&&"PONG"===(null===(t=e.data)||void 0===t?void 0:t.payload)&&n(!0)},n=n=>{e(n),window.removeEventListener("message",s),clearTimeout(t)};w({type:c.Request,payload:"PING"}),window.addEventListener("message",s);const t=setTimeout(()=>n(!1),500)})}function p(e){let s,n=!1;const t=async(r=0)=>{const o=r<5,a=await u();n!==a&&(e(a),n=a),s=setTimeout(t,a?1e4:o?0:5e3,o?r+1:r)};return t(),()=>clearTimeout(s)}function m(e){let s,n=null;const t=async()=>{try{const s=await l();o=n,(null===(r=s)?null===o:r.pkh===(null==o?void 0:o.pkh)&&r.rpc===(null==o?void 0:o.rpc))||(e(s),n=s)}catch{}var r,o;s=setTimeout(t,1e4)};return t(),()=>clearTimeout(s)}async function l(){const e=await P({type:a.GetCurrentPermissionRequest});return y(e.type===a.GetCurrentPermissionResponse),e.permission}async function d(e,s,n){const t=await P({type:a.PermissionRequest,network:e,appMeta:s,force:n});return y(t.type===a.PermissionResponse),{rpc:t.rpc,pkh:t.pkh,publicKey:t.publicKey}}async function R(e,s){const n=await P({type:a.OperationRequest,sourcePkh:e,opParams:s});return y(n.type===a.OperationResponse),n.opHash}async function h(e,s){const n=await P({type:a.SignRequest,sourcePkh:e,payload:s});return y(n.type===a.SignResponse),n.signature}async function E(e){const s=await P({type:a.BroadcastRequest,signedOpBytes:e});return y(s.type===a.BroadcastResponse),s.opHash}function P(n){return new Promise((t,r)=>{const o=e(),a=e=>{const n=e.data;switch(!0){case e.source!==window||(null==n?void 0:n.reqId)!==o:return;case(null==n?void 0:n.type)===c.Response:t(n.payload),window.removeEventListener("message",a);break;case(null==n?void 0:n.type)===c.ErrorResponse:r(function(e){switch(!0){case e===i.NotGranted:return new T;case e===i.NotFound:return new N;case e===i.InvalidParams:return new O;case Array.isArray(e)&&e[0]===i.TezosOperation&&Array.isArray(e[1])&&e[1].length>0:return new s(e[1]);case"string"==typeof e&&e.startsWith("__tezos__"):return new Error(e.replace("__tezos__",""));default:return new S}}(n.payload)),window.removeEventListener("message",a)}};w({type:c.Request,payload:n,reqId:o}),window.addEventListener("message",a)})}function y(e){if(!e)throw new Error("Invalid response recieved")}function w(e){window.postMessage(e,"*")}!function(e){e.GetCurrentPermissionRequest="GET_CURRENT_PERMISSION_REQUEST",e.GetCurrentPermissionResponse="GET_CURRENT_PERMISSION_RESPONSE",e.PermissionRequest="PERMISSION_REQUEST",e.PermissionResponse="PERMISSION_RESPONSE",e.OperationRequest="OPERATION_REQUEST",e.OperationResponse="OPERATION_RESPONSE",e.SignRequest="SIGN_REQUEST",e.SignResponse="SIGN_RESPONSE",e.BroadcastRequest="BROADCAST_REQUEST",e.BroadcastResponse="BROADCAST_RESPONSE"}(a||(a={})),function(e){e.NotGranted="NOT_GRANTED",e.NotFound="NOT_FOUND",e.InvalidParams="INVALID_PARAMS",e.TezosOperation="TEZOS_OPERATION"}(i||(i={})),function(e){e.Request="THANOS_PAGE_REQUEST",e.Response="THANOS_PAGE_RESPONSE",e.ErrorResponse="THANOS_PAGE_ERROR_RESPONSE"}(c||(c={}));class S{constructor(){this.name="ThanosWalletError",this.message="An unknown error occured. Please try again or report it"}}class T extends S{constructor(){super(...arguments),this.name="NotGrantedThanosWalletError",this.message="Permission Not Granted"}}class N extends S{constructor(){super(...arguments),this.name="NotFoundThanosWalletError",this.message="Account Not Found. Try connect again"}}class O extends S{constructor(){super(...arguments),this.name="InvalidParamsThanosWalletError",this.message="Some of the parameters you provided are invalid"}}class _{constructor(e,s){this.appName=e,this.permission=null,s&&(this.permission=s)}get connected(){return Boolean(this.permission)}toTezos(){g(this.permission);const e=new n(this.permission.rpc);return e.setProvider({wallet:this}),e}async connect(e,s={forcePermission:!1}){const n=await d(e,{name:this.appName},s.forcePermission);this.permission=n}reconnect(e){return this.connect(e,{forcePermission:!0})}async getPKH(){return g(this.permission),this.permission.pkh}async mapTransferParamsToWalletParams(e){return t(e)}async mapOriginateParamsToWalletParams(e){return r(e)}async mapDelegateParamsToWalletParams(e){return o(e)}async sendOperations(e){return g(this.permission),R(this.permission.pkh,e.map(v))}async sign(e){return g(this.permission),h(this.permission.pkh,e)}async broadcast(e){return g(this.permission),E(e)}}_.isAvailable=u,_.onAvailabilityChange=p,_.getCurrentPermission=l,_.onPermissionChange=m;class f extends S{constructor(){super(...arguments),this.name="ThanosWalletNotConnected",this.message="You need to connect ThanosWallet by calling thanosWallet.connect() first"}}function g(e){if(!e)throw new f}function v(e){const{...s}=e;switch(e.kind){case"origination":return{...s,mutez:!0};case"transaction":const{destination:e,amount:n,parameters:t,...r}=s;return{...r,to:e,amount:+n,mutez:!0,parameter:t};default:return s}}export{O as InvalidParamsThanosWalletError,f as NotConnectedThanosWalletError,N as NotFoundThanosWalletError,T as NotGrantedThanosWalletError,i as ThanosDAppErrorType,a as ThanosDAppMessageType,c as ThanosPageMessageType,_ as ThanosWallet,S as ThanosWalletError,l as getCurrentPermission,u as isAvailable,p as onAvailabilityChange,m as onPermissionChange,E as requestBroadcast,R as requestOperation,d as requestPermission,h as requestSign};
//# sourceMappingURL=index.modern.js.map
