!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("nanoid"),require("@taquito/taquito")):"function"==typeof define&&define.amd?define(["exports","nanoid","@taquito/taquito"],r):r((e=e||self).dapp={},e.nanoid,e.taquito)}(this,function(e,r,n){var t,o,s;function a(){return(a=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e}).apply(this,arguments)}function i(e,r){e.prototype=Object.create(r.prototype),e.prototype.constructor=e,e.__proto__=r}function u(e,r){if(null==e)return{};var n,t,o={},s=Object.keys(e);for(t=0;t<s.length;t++)r.indexOf(n=s[t])>=0||(o[n]=e[n]);return o}(t=e.ThanosDAppMessageType||(e.ThanosDAppMessageType={})).GetCurrentPermissionRequest="GET_CURRENT_PERMISSION_REQUEST",t.GetCurrentPermissionResponse="GET_CURRENT_PERMISSION_RESPONSE",t.PermissionRequest="PERMISSION_REQUEST",t.PermissionResponse="PERMISSION_RESPONSE",t.OperationRequest="OPERATION_REQUEST",t.OperationResponse="OPERATION_RESPONSE",t.SignRequest="SIGN_REQUEST",t.SignResponse="SIGN_RESPONSE",t.BroadcastRequest="BROADCAST_REQUEST",t.BroadcastResponse="BROADCAST_RESPONSE",(o=e.ThanosDAppErrorType||(e.ThanosDAppErrorType={})).NotGranted="NOT_GRANTED",o.NotFound="NOT_FOUND",o.InvalidParams="INVALID_PARAMS",o.TezosOperation="TEZOS_OPERATION",(s=e.ThanosPageMessageType||(e.ThanosPageMessageType={})).Request="THANOS_PAGE_REQUEST",s.Response="THANOS_PAGE_RESPONSE",s.ErrorResponse="THANOS_PAGE_ERROR_RESPONSE";var p=function(r){try{return Promise.resolve(P({type:e.ThanosDAppMessageType.BroadcastRequest,signedOpBytes:r})).then(function(r){return d(r.type===e.ThanosDAppMessageType.BroadcastResponse),r.opHash})}catch(e){return Promise.reject(e)}},c=function(r,n){try{return Promise.resolve(P({type:e.ThanosDAppMessageType.SignRequest,sourcePkh:r,payload:n})).then(function(r){return d(r.type===e.ThanosDAppMessageType.SignResponse),r.signature})}catch(e){return Promise.reject(e)}},l=function(r,n){try{return Promise.resolve(P({type:e.ThanosDAppMessageType.OperationRequest,sourcePkh:r,opParams:n})).then(function(r){return d(r.type===e.ThanosDAppMessageType.OperationResponse),r.opHash})}catch(e){return Promise.reject(e)}},m=function(r,n,t){try{return Promise.resolve(P({type:e.ThanosDAppMessageType.PermissionRequest,network:r,appMeta:n,force:t})).then(function(r){return d(r.type===e.ThanosDAppMessageType.PermissionResponse),{rpc:r.rpc,pkh:r.pkh,publicKey:r.publicKey}})}catch(e){return Promise.reject(e)}},h=function(){try{return Promise.resolve(P({type:e.ThanosDAppMessageType.GetCurrentPermissionRequest})).then(function(r){return d(r.type===e.ThanosDAppMessageType.GetCurrentPermissionResponse),r.permission})}catch(e){return Promise.reject(e)}};function T(){return new Promise(function(r){var n=function(r){var n,o;r.source===window&&(null===(n=r.data)||void 0===n?void 0:n.type)===e.ThanosPageMessageType.Response&&"PONG"===(null===(o=r.data)||void 0===o?void 0:o.payload)&&t(!0)},t=function(e){r(e),window.removeEventListener("message",n),clearTimeout(o)};v({type:e.ThanosPageMessageType.Request,payload:"PING"}),window.addEventListener("message",n);var o=setTimeout(function(){return t(!1)},500)})}function f(e){var r,n=!1;return function t(o){void 0===o&&(o=0);try{var s=o<5;return Promise.resolve(T()).then(function(a){n!==a&&(e(a),n=a),r=setTimeout(t,a?1e4:s?0:5e3,s?o+1:o)})}catch(e){return Promise.reject(e)}}(),function(){return clearTimeout(r)}}function y(e){var r,n=null;return function t(){try{var o=function(){r=setTimeout(t,1e4)},s=function(r,t){try{var o=Promise.resolve(h()).then(function(r){var t,o;o=n,(null===(t=r)?null===o:t.pkh===(null==o?void 0:o.pkh)&&t.rpc===(null==o?void 0:o.rpc))||(e(r),n=r)})}catch(e){return}return o&&o.then?o.then(void 0,function(){}):o}();return Promise.resolve(s&&s.then?s.then(o):o())}catch(e){return Promise.reject(e)}}(),function(){return clearTimeout(r)}}function P(t){return new Promise(function(o,s){var a=r.nanoid();v({type:e.ThanosPageMessageType.Request,payload:t,reqId:a}),window.addEventListener("message",function r(t){var i=t.data;switch(!0){case t.source!==window||(null==i?void 0:i.reqId)!==a:return;case(null==i?void 0:i.type)===e.ThanosPageMessageType.Response:o(i.payload),window.removeEventListener("message",r);break;case(null==i?void 0:i.type)===e.ThanosPageMessageType.ErrorResponse:s(function(r){switch(!0){case r===e.ThanosDAppErrorType.NotGranted:return new E;case r===e.ThanosDAppErrorType.NotFound:return new R;case r===e.ThanosDAppErrorType.InvalidParams:return new O;case Array.isArray(r)&&r[0]===e.ThanosDAppErrorType.TezosOperation&&Array.isArray(r[1])&&r[1].length>0:return new n.TezosOperationError(r[1]);case"string"==typeof r&&r.startsWith("__tezos__"):return new Error(r.replace("__tezos__",""));default:return new g}}(i.payload)),window.removeEventListener("message",r)}})})}function d(e){if(!e)throw new Error("Invalid response recieved")}function v(e){window.postMessage(e,"*")}var g=function(){this.name="ThanosWalletError",this.message="An unknown error occured. Please try again or report it"},E=function(e){function r(){var r;return(r=e.apply(this,arguments)||this).name="NotGrantedThanosWalletError",r.message="Permission Not Granted",r}return i(r,e),r}(g),R=function(e){function r(){var r;return(r=e.apply(this,arguments)||this).name="NotFoundThanosWalletError",r.message="Account Not Found. Try connect again",r}return i(r,e),r}(g),O=function(e){function r(){var r;return(r=e.apply(this,arguments)||this).name="InvalidParamsThanosWalletError",r.message="Some of the parameters you provided are invalid",r}return i(r,e),r}(g),A=function(){function e(e,r){this.appName=e,this.permission=null,r&&(this.permission=r)}var r,t=e.prototype;return t.toTezos=function(){N(this.permission);var e=new n.TezosToolkit(this.permission.rpc);return e.setProvider({wallet:this}),e},t.connect=function(e,r){void 0===r&&(r={forcePermission:!1});try{var n=this;return Promise.resolve(m(e,{name:n.appName},r.forcePermission)).then(function(e){n.permission=e})}catch(e){return Promise.reject(e)}},t.reconnect=function(e){return this.connect(e,{forcePermission:!0})},t.getPKH=function(){try{return N(this.permission),Promise.resolve(this.permission.pkh)}catch(e){return Promise.reject(e)}},t.mapTransferParamsToWalletParams=function(e){try{return Promise.resolve(n.createTransferOperation(e))}catch(e){return Promise.reject(e)}},t.mapOriginateParamsToWalletParams=function(e){try{return Promise.resolve(n.createOriginationOperation(e))}catch(e){return Promise.reject(e)}},t.mapDelegateParamsToWalletParams=function(e){try{return Promise.resolve(n.createSetDelegateOperation(e))}catch(e){return Promise.reject(e)}},t.sendOperations=function(e){try{return N(this.permission),Promise.resolve(l(this.permission.pkh,e.map(_)))}catch(e){return Promise.reject(e)}},t.sign=function(e){try{return N(this.permission),Promise.resolve(c(this.permission.pkh,e))}catch(e){return Promise.reject(e)}},t.broadcast=function(e){try{return N(this.permission),Promise.resolve(p(e))}catch(e){return Promise.reject(e)}},(r=[{key:"connected",get:function(){return Boolean(this.permission)}}])&&function(e,r){for(var n=0;n<r.length;n++){var t=r[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}(e.prototype,r),e}();A.isAvailable=T,A.onAvailabilityChange=f,A.getCurrentPermission=h,A.onPermissionChange=y;var S=function(e){function r(){var r;return(r=e.apply(this,arguments)||this).name="ThanosWalletNotConnected",r.message="You need to connect ThanosWallet by calling thanosWallet.connect() first",r}return i(r,e),r}(g);function N(e){if(!e)throw new S}function _(e){var r=u(e,["fee","gas_limit","storage_limit"]);switch(e.kind){case"origination":return a({},r,{mutez:!0});case"transaction":var n=r.destination,t=r.amount,o=r.parameters;return a({},u(r,["destination","amount","parameters"]),{to:n,amount:+t,mutez:!0,parameter:o});default:return r}}e.InvalidParamsThanosWalletError=O,e.NotConnectedThanosWalletError=S,e.NotFoundThanosWalletError=R,e.NotGrantedThanosWalletError=E,e.ThanosWallet=A,e.ThanosWalletError=g,e.getCurrentPermission=h,e.isAvailable=T,e.onAvailabilityChange=f,e.onPermissionChange=y,e.requestBroadcast=p,e.requestOperation=l,e.requestPermission=m,e.requestSign=c});
//# sourceMappingURL=index.umd.js.map
